# API Gateway 项目架构文档

## 1. 项目概述

这是一个基于 FastAPI 的 API 网关服务，主要用于整合和代理多个后端微服务。该网关提供统一的 API 入口，处理认证、请求路由、服务转发等核心功能。

## 2. 系统架构

### 2.1 核心组件

#### API网关主服务 (`api.py`)
- 提供统一的 API 入口
- 处理请求路由和转发
- 实现认证和中间件功能
- 集成多个微服务的 API

#### 认证系统 (`authentication/`)
- 实现 OAuth2 认证机制
- 包含 JWT token 生成和验证
- 用户认证和授权管理

### 2.2 集成的后端服务

```python
BACKEND_SERVICES = {
    "llm": "大语言模型服务",
    "stt": "语音转文本服务",
    "tts": "文本转语音服务",
    "ocr": "光学字符识别服务",
    "user": "用户管理服务",
    "md2pdf": "Markdown转PDF服务"
}
```

## 3. 功能模块

### 3.1 LLM服务集成
- 聊天补全功能
- 聊天标题生成
- 图片代理服务

### 3.2 语音服务
- 语音转文本 (STT)
  - 支持多语言转写
  - VAD 过滤
  - 可配置的参数
- 文本转语音 (TTS)
  - 多语言支持
  - 可调节语速
  - 多说话人支持

### 3.3 文档处理
- OCR服务
  - 文档识别
  - 异步任务处理
  - 结果查询
- Markdown转PDF
  - 文档转换
  - 文件下载
  - 可选图片处理

### 3.4 用户系统
- 用户管理
  - 用户添加/删除
  - 用户查询
- 聊天会话管理
  - 会话创建/编辑/删除
  - 标题更新
  - 历史记录查询

## 4. 安全特性

### 4.1 IP限制功能
- 登录IP锁定
  - 错误尝试次数限制
  - 锁定时间窗口
  - 自动解锁机制
- 并发请求限制
  - 每IP最大并发数控制
  - 异步锁保护

### 4.2 认证授权
- OAuth2认证流程
- JWT Token验证
- 用户权限控制

## 5. 技术栈

- **Web框架**: FastAPI
- **数据验证**: Pydantic
- **HTTP客户端**: httpx
- **认证**: JWT, OAuth2
- **其他**: uvicorn, asyncio

## 6. 项目结构

```
.
├── api.py              # 主应用入口和API定义
├── authentication/     # 认证相关代码
│   ├── auth.py        # 核心认证逻辑
│   ├── auth_config.json
│   └── generate_*.py  # 工具脚本
├── history/           # 历史记录
└── test.py           # 测试文件
```

## 7. 设计特点

### 7.1 模块化设计
- 服务独立封装
- 便于维护和扩展
- 清晰的职责分离

### 7.2 异步处理
- FastAPI异步框架
- httpx异步HTTP客户端
- 高性能请求处理

### 7.3 安全性考虑
- 完善的认证机制
- 请求限制
- IP追踪

### 7.4 可配置性
- 环境变量配置
- 配置文件管理
- 服务参数可调

### 7.5 健康检查
- 服务健康监控
- 状态检查端点
- 错误处理机制

## 8. 扩展性

### 8.1 服务扩展
- 通过 `BACKEND_SERVICES` 配置添加新服务
- 模块化的路由器系统
- 灵活的中间件扩展

### 8.2 功能扩展
- 中间件系统支持新功能添加
- 路由器模式支持API端点扩展
- 服务配置支持参数调整

## 9. 部署要求

### 9.1 环境要求
- Python 3.x
- Linux/Unix系统推荐
- 网络连接要求

### 9.2 依赖服务
- 后端微服务的可用性
- 网络连接性
- 存储需求

## 10. 最佳实践

### 10.1 开发建议
- 遵循异步编程模式
- 注意错误处理
- 保持代码模块化

### 10.2 部署建议
- 使用环境变量管理配置
- 监控服务健康状态
- 实施适当的日志记录

### 10.3 安全建议
- 定期更新依赖
- 监控异常访问
- 实施适当的备份策略 