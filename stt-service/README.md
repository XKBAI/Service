# Faster-Whisper STT å¾®æœåŠ¡

åŸºäº faster-whisper çš„é«˜æ€§èƒ½è¯­éŸ³è½¬å½•å¾®æœåŠ¡ï¼Œæ”¯æŒ GPU åŠ é€Ÿå’Œå¤§è§„æ¨¡å¹¶å‘å¤„ç†ã€‚

## ğŸš€ ç‰¹æ€§

- âš¡ **é«˜æ€§èƒ½**: åŸºäº `app2.py` - æ”¯æŒ20ä¸ªå¹¶å‘ä»»åŠ¡
- ğŸ¯ **æ¨¡å‹ä¼˜åŒ–**: ä½¿ç”¨ large-v3 æ¨¡å‹ï¼Œè¯†åˆ«ç²¾åº¦é«˜
- ğŸ’¾ **å†…å­˜ä¼˜åŒ–**: ç›´æ¥å¤„ç†éŸ³é¢‘æ•°æ®ï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶
- ğŸ”¥ **æ¨¡å‹é¢„çƒ­**: å‡å°‘é¦–æ¬¡è¯·æ±‚å»¶è¿Ÿ
- ğŸ“Š **å®Œæ•´ç›‘æ§**: å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§
- ğŸ³ **å®¹å™¨åŒ–**: ç”Ÿäº§çº§ Docker é…ç½®

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
faster-whisper/
â”œâ”€â”€ app2.py              # ğŸ”¥ ä¸»æœåŠ¡æ–‡ä»¶ï¼ˆé«˜æ€§èƒ½ç‰ˆæœ¬ï¼‰
â”œâ”€â”€ Dockerfile          # å®¹å™¨æ„å»ºé…ç½®
â”œâ”€â”€ requirements.txt    # Pythonä¾èµ–
â”œâ”€â”€ .dockerignore       # æ„å»ºå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ large-v3/           # æœ¬åœ°æ¨¡å‹æ–‡ä»¶
â””â”€â”€ README.md           # æœ¬æ–‡æ¡£
```

## ğŸ› ï¸ éƒ¨ç½²æ–¹å¼

### æ–¹å¼1: ä½¿ç”¨ä¸Šçº§ç›®å½•çš„ docker-compose.ymlï¼ˆæ¨èï¼‰

```bash
# åœ¨ /home/xkb2/Desktop/QY ç›®å½•ä¸‹
cd /home/xkb2/Desktop/QY

# å¯åŠ¨ STT æœåŠ¡
docker-compose up -d faster-whisper-stt

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f faster-whisper-stt

# åœæ­¢æœåŠ¡
docker-compose down
```

### æ–¹å¼2: å•ç‹¬æ„å»ºè¿è¡Œ

```bash
cd faster-whisper

# æ„å»ºé•œåƒ
docker build -t faster-whisper-stt:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name faster-whisper-stt \
  --gpus all \
  -p 57001:57001 \
  -v $(pwd)/large-v3:/tmp/faster_whisper/models--Systran--faster-whisper-large-v3/snapshots/main:ro \
  faster-whisper-stt:latest
```

## ğŸ”§ API ä½¿ç”¨

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:57001/stt/health
```

### éŸ³é¢‘è½¬å½•
```bash
curl -X POST "http://localhost:57001/stt/transcribe/" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@audio.mp3" \
  -F "language=zh" \
  -F "beam_size=5"
```

### æ¸…ç†GPUå†…å­˜
```bash
curl -X POST "http://localhost:57001/stt/clear-memory"
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
- `MODEL_SIZE`: æ¨¡å‹å¤§å°ï¼Œé»˜è®¤ `large-v3`
- `CUDA_VISIBLE_DEVICES`: GPUè®¾å¤‡IDï¼Œé»˜è®¤ `0`

### æ¨¡å‹æŒ‚è½½
- æœ¬åœ°æ¨¡å‹: `./large-v3` â†’ `/tmp/faster_whisper/models--Systran--faster-whisper-large-v3/snapshots/main`
- ç¼“å­˜ç›®å½•: `./models/whisper` â†’ `/tmp/faster_whisper`

### èµ„æºé™åˆ¶
- å†…å­˜: 8GB
- CPU: 4æ ¸
- GPU: 1å¼ æ˜¾å¡

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|---|------|
| å¹¶å‘å¤„ç† | 20ä¸ªä»»åŠ¡ | åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•° |
| æ”¯æŒæ ¼å¼ | MP3, WAV, FLAC, OGG, M4A | éŸ³é¢‘æ–‡ä»¶æ ¼å¼ |
| å“åº”æ—¶é—´ | 1-3ç§’ | å–å†³äºéŸ³é¢‘é•¿åº¦ |
| å¯åŠ¨æ—¶é—´ | 60-90ç§’ | åŒ…å«æ¨¡å‹åŠ è½½æ—¶é—´ |

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€
```bash
# å®¹å™¨è¿è¡ŒçŠ¶æ€
docker ps | grep faster-whisper

# èµ„æºä½¿ç”¨æƒ…å†µ
docker stats faster-whisper-stt-service

# GPUä½¿ç”¨æƒ…å†µ
nvidia-smi
```

### æ—¥å¿—æŸ¥çœ‹
```bash
# å®æ—¶æ—¥å¿—
docker logs -f faster-whisper-stt-service

# æœ€è¿‘100è¡Œæ—¥å¿—
docker logs --tail=100 faster-whisper-stt-service
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¯åŠ¨æ…¢**
   - åŸå› : éœ€è¦åŠ è½½3GB+çš„æ¨¡å‹æ–‡ä»¶
   - è§£å†³: è€å¿ƒç­‰å¾…ï¼ŒæŸ¥çœ‹æ—¥å¿—ç¡®è®¤åŠ è½½è¿›åº¦

2. **å†…å­˜ä¸è¶³**
   - åŸå› : æ¨¡å‹å¤ªå¤§æˆ–å¹¶å‘æ•°è¿‡é«˜
   - è§£å†³: å‡å°‘å¹¶å‘æ•°æˆ–ä½¿ç”¨æ›´å°çš„æ¨¡å‹

3. **GPUä¸å¯ç”¨**
   - åŸå› : CUDAç¯å¢ƒé—®é¢˜
   - è§£å†³: æ£€æŸ¥nvidia-dockerå®‰è£…ï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨é™çº§åˆ°CPU

4. **æ¨¡å‹æ–‡ä»¶ç¼ºå¤±**
   - åŸå› : `large-v3` ç›®å½•ä¸å­˜åœ¨
   - è§£å†³: ç¡®ä¿æ¨¡å‹æ–‡ä»¶å·²ä¸‹è½½åˆ°æ­£ç¡®ä½ç½®

### æ€§èƒ½ä¼˜åŒ–

1. **é¢„çƒ­æ¨¡å‹**: å¯åŠ¨åå‘é€ä¸€æ¬¡æµ‹è¯•è¯·æ±‚
2. **æ‰¹é‡å¤„ç†**: åˆå¹¶å¤šä¸ªçŸ­éŸ³é¢‘æ–‡ä»¶
3. **ç¼“å­˜ç»“æœ**: å¯¹ç›¸åŒéŸ³é¢‘é¿å…é‡å¤è½¬å½•

## ğŸ” å®‰å…¨é…ç½®

- âœ… érootç”¨æˆ·è¿è¡Œ (appuser:1000)
- âœ… æœ€å°åŒ–åŸºç¡€é•œåƒ
- âœ… åªæš´éœ²å¿…è¦ç«¯å£
- âœ… å¥åº·æ£€æŸ¥æœºåˆ¶
- âœ… æ—¥å¿—è½®è½¬é…ç½®

## ğŸ“ å¼€å‘è¯´æ˜

æ­¤å¾®æœåŠ¡åŸºäº `app2.py` æ„å»ºï¼Œå…·æœ‰ä»¥ä¸‹æŠ€æœ¯ç‰¹ç‚¹ï¼š

- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨ asyncio å’Œ ThreadPoolExecutor
- **å†…å­˜ä¼˜åŒ–**: ç›´æ¥å¤„ç† BytesIOï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶
- **å¹¶å‘æ§åˆ¶**: ä¿¡å·é‡é™åˆ¶å¹¶å‘æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½
- **æ¨¡å‹ç®¡ç†**: æ”¯æŒé¢„çƒ­å’Œå†…å­˜æ¸…ç†
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œå“åº”