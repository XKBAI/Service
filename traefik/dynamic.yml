# traefik/dynamic.yml - æ­£ç¡®çš„åŠ¨æ€é…ç½®æ–‡ä»¶

http:
  # æœåŠ¡å®šä¹‰
  services:
    auth-error-service:
      loadBalancer:
        servers:
          - url: "http://AUTH:9000"

  # ä¸­é—´ä»¶å®šä¹‰
  middlewares:
    # ğŸ”¥ ForwardAuth è®¤è¯ä¸­é—´ä»¶
    global-auth:
      forwardAuth:
        address: "http://AUTH:9000/validate"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
          - "X-Forwarded-For"
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
          - "X-Real-IP"
          - "X-Forwarded-Uri"
        authResponseHeaders:
          - "X-User"
          - "X-User-Role"
          - "X-Auth-Status"
        trustForwardHeader: true

    # ğŸ”¥ CORS ä¸­é—´ä»¶
    cors-headers:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "PATCH"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-API-Key"
          - "X-Requested-With"
          - "Accept"
          - "Origin"
          - "Cache-Control"
        accessControlAllowOriginList:
          - "https://localhost:8443"
          - "https://xkb.744204541.xyz:8443"
          - "http://localhost:3000"
          - "*"
        accessControlMaxAge: 86400
        accessControlAllowCredentials: true

    # ğŸ”¥ å®‰å…¨å¤´éƒ¨ä¸­é—´ä»¶
    secure-headers:
      headers:
        frameDeny: false
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Port: "8443"
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
        hostsProxyHeaders:
          - "X-Forwarded-Host"
          - "X-Forwarded-For"
          - "X-Forwarded-Proto"
          - "X-Real-IP"

    # ğŸ”¥ é™æµä¸­é—´ä»¶
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 60s
        sourceCriterion:
          ipStrategy:
            depth: 1
            excludedIPs:
              - "127.0.0.1"
              - "::1"
              - "172.16.0.0/12"

    # ğŸ”¥ Dashboard åŸºç¡€è®¤è¯ä¸­é—´ä»¶
    dashboard-auth:
      basicAuth:
        users:
          # admin:admin123
          - "admin:$2y$10$K.9qKTJWmBYVJ8hgKtPbluBF6bJXsXKb8fNDJ7J1h2VG3ysMKW1nO"
        realm: "Traefik Dashboard"
        removeHeader: true

    # ğŸ”¥ é‡å®šå‘åˆ° HTTPS
    redirect-to-https:
      redirectScheme:
        scheme: "https"
        port: "8443"
        permanent: true

    # ğŸ”¥ é”™è¯¯é¡µé¢ä¸­é—´ä»¶
    auth-errors:
      errors:
        status:
          - "401"
          - "403"
        service: auth-error-service
        query: "/login?redirect={uri}"

    # ==================== ä¸­é—´ä»¶ç»„åˆ ====================

    # ğŸ”¥ å—ä¿æŠ¤çš„ API æœåŠ¡
    protected-api:
      chain:
        middlewares:
          - "auth-errors"
          - "global-auth"
          - "cors-headers"

    # ğŸ”¥ å—ä¿æŠ¤çš„æ™®é€šæœåŠ¡
    protected-service:
      chain:
        middlewares:
          - "global-auth"
          - "cors-headers"
          - "rate-limit"

    # ğŸ”¥ å—ä¿æŠ¤çš„ç®¡ç†æœåŠ¡ï¼ˆåŒé‡è®¤è¯ï¼‰
    protected-admin:
      chain:
        middlewares:
          - "global-auth"
          - "dashboard-auth"
          - "secure-headers"

# TLS é…ç½®
tls:
  options:
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
      curvePreferences:
        - "CurveP521"
        - "CurveP384"
      sniStrict: false